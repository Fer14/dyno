<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DYNO</title>
    <link rel="icon" type="image/png" href="asset/icon.png">
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sono:wght@200;300;400;500;600;700;800&display=swap');        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0a0f0a 0%, #1a2f1a 50%, #0f1f0f 100%);
            font-family: 'Sono', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #c9f0c9;
            overflow-x: hidden;
        }
        
        .background-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .mystical-particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: radial-gradient(circle, #199b34, transparent);
            border-radius: 50%;
            animation: float 6s infinite ease-in-out;
            opacity: 0.7;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            33% { transform: translateY(-20px) rotate(120deg); opacity: 0.8; }
            66% { transform: translateY(-10px) rotate(240deg); opacity: 0.5; }
        }
        
        .title {
            font-family: 'Sono', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            text-align: center;
            margin: 2rem 0;
            background: white;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(16, 185, 129, 0.3);
            letter-spacing: 3px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 2rem;
            color: white;
            opacity: 0.8;
            letter-spacing: 1px;
        }
        
        .model-upload {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid #199b34;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 3rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px #199b34;
            transition: all 0.3s ease;
        }
        
        .model-upload:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px #199b34;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            overflow: hidden;
            border-radius: 10px;
            background: #199b34;
            padding: 1rem 2rem;
            transition: all 0.3s ease;
        }
        
        .file-input-wrapper:hover {
            background: #199b34;
            transform: scale(1.05);
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-label {
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }
        
        .model-status {
            margin-top: 1rem;
            font-size: 1rem;
            text-align: center;
            color: white;
        }
        
        .egg-container {
            position: relative;
            margin: 2rem 0;
            transform-style: preserve-3d;
            display: flex;
            justify-content: center; /* horizontal */
            align-items: center; 
        }
        
        .dragon-egg {
            width: 200px;
            height: 260px;
            background: url('assets/egg1.png') no-repeat center;
            background-size:  180% auto;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            position: relative;
            cursor: pointer;
            transition: all 0.5s ease;
            box-shadow: 
                0 10px 30px rgba(16, 185, 129, 0.4),
                inset -20px -20px 40px rgba(0, 0, 0, 0.3),
                inset 20px 20px 40px rgba(255, 255, 255, 0.1);
            animation: pulse 3s infinite ease-in-out;
            overflow: hidden; 
        }
        
        .dragon-egg:hover {
            transform: scale(1.05) rotateY(10deg);
            box-shadow: 
                0 15px 40px rgba(16, 185, 129, 0.6),
                inset -20px -20px 40px rgba(0, 0, 0, 0.3),
                inset 20px 20px 40px rgba(255, 255, 255, 0.2);
        }
        
        .dragon-egg.hatching {
            animation: shake 0.5s infinite ease-in-out;
        }
        
        .dragon-egg.cracked {
            background: #199b34;
            animation: crackGlow 1.5s ease-in-out forwards;
            background: url('assets/egg3.png') no-repeat center;
            background-size:  180% auto;;
        }

        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 15px 35px rgba(16, 185, 129, 0.6);
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10% { transform: translateX(-8px) rotate(-2deg); }
            20% { transform: translateX(8px) rotate(2deg); }
            30% { transform: translateX(-6px) rotate(-1deg); }
            40% { transform: translateX(6px) rotate(1deg); }
            50% { transform: translateX(-4px) rotate(-0.5deg); }
            60% { transform: translateX(4px) rotate(0.5deg); }
            70% { transform: translateX(-2px) rotate(-0.25deg); }
            80% { transform: translateX(2px) rotate(0.25deg); }
            90% { transform: translateX(-1px) rotate(-0.1deg); }
        }
        
        @keyframes crackGlow {
            0% { 
                box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 
                    0 20px 50px rgba(16, 185, 129, 1), 
                    inset 0 0 30px rgba(16, 185, 129, 0.5),
                    0 0 100px rgba(255, 255, 255, 0.3);
                transform: scale(1.15);
            }
            100% { 
                box-shadow: 
                    0 15px 40px rgba(16, 185, 129, 0.6),
                    inset 0 0 20px rgba(16, 185, 129, 0.3);
                transform: scale(1.05);
            }
        }
        
        .egg-patterns {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: inherit;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.2) 5px, transparent 5px),
                radial-gradient(circle at 70% 60%, rgba(255,255,255,0.15) 8px, transparent 8px),
                radial-gradient(circle at 50% 80%, rgba(255,255,255,0.1) 12px, transparent 12px);
        }
        
 
        .egg-glow {
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.3), transparent 70%);
            border-radius: 50%;
            animation: glow 2s infinite alternate ease-in-out;
            z-index: -1;
        }
        
        @keyframes glow {
            0% { transform: scale(0.9); opacity: 0.5; }
            100% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .hatch-instruction {
            text-align: center;
            margin-top: 1rem;
            font-size: 1.1rem;
            color: white;
            /* font-style: italic; */
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease;
        }
        
        .hatch-instruction.hidden {
            opacity: 0;
            transform: translateY(-20px);
        }
        
        .canvas-container {
            position: relative;
            margin-top: 2rem;
            margin-bottom: 2rem;
            opacity: 0;
            transform: scale(0.5) translateY(50px);
            transition: all 1s ease;
            display: flex;
            flex-direction: column;
            align-items: center;  /* horizontal center */
            justify-content: center; /* vertical center if needed */
        }
        
        .canvas-container.revealed {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
        
        .dragon-canvas {
            border: 3px solid white;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 
                0 0 30px rgba(16, 185, 129, 0.5),
                inset 0 0 20px rgba(16, 185, 129, 0.1);
        }
        
        .canvas-title {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            letter-spacing: 2px;
        }
        
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 4px solid rgba(16, 185, 129, 0.3);
            border-top: 4px solid #199b34;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .loading-spinner.active {
            opacity: 1;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .status-message {
            text-align: center;
            margin-top: 1rem;
            font-size: 1rem;
            color: #6ee7b7;
            min-height: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .dragon-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .dragon-popup.active {
            opacity: 1;
            visibility: visible;
        }
        
        .popup-content {
            position: relative;
            background: linear-gradient(135deg, #0f1f0f, #1a2f1a);
            border: 3px solid white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            box-shadow: 
                0 0 50px #199b34,
                inset 0 0 30px rgba(16, 185, 129, 0.1);
            transform: scale(0.5);
            transition: transform 0.3s ease;
        }
        
        .dragon-popup.active .popup-content {
            transform: scale(1);
        }
        
        .popup-title {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1.5rem;
            letter-spacing: 2px;
        }
        
        .popup-canvas {
            border: 2px solid #199b34;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 
                0 0 30px rgba(16, 185, 129, 0.6),
                inset 0 0 20px rgba(16, 185, 129, 0.2);
            display: block;
            margin: 0 auto;
        }
        
        .close-popup {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #199b34;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: #199b34;
            font-size: 1.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .close-popup:hover {
            background: rgba(16, 185, 129, 0.4);
            transform: rotate(90deg);
        }
        
        .popup-instructions {
            text-align: center;
            margin-top: 1rem;
            color: white;
            font-style: italic;
            opacity: 0.8;
        }

        .dragon-row {
            display: flex;
            align-items: center; /* vertically centers the items */
            gap: 10px; /* space between image and title */
        }

        .dragon-image {
            width: 55px; /* adjust as needed */
            height: auto;
        }

        #hatchedDragonsSection {
            display: none; /* hidden until first dragon */
        }


        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .tab-button {
            background: rgba(25, 155, 52, 0.4);
            color: white;
            border: 2px solid #199b34;
            padding: 0.7rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
        }
        .tab-button.active {
            background: #199b34;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        #reproduceButton {
            background: #e3390b;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
            display:block; 
            margin: 2rem auto;
            padding: 1rem 2rem;
             font-size: 1.2rem;
        }

        #reproduceButton:active {
            background: #c32a00; /* darker shade of the original color */
            transform: scale(0.97); /* slightly shrink button when pressed */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* optional subtle shadow */
        }

        #reproduceButton:hover {
            background: #ff4b23; /* slightly brighter shade */
        }

    </style>
</head>
<body>
    <div class="background-effects" id="backgroundEffects"></div>
    
    <div class="dragon-row">
        <img src="assets/icon.png" alt="Mystical Dragon" class="dragon-image">
        <h1 class="title">DYNO</h1>
    </div>
    <p class="subtitle" >Combine and discover unique mysterious dragons</p>

    <div class="model-upload">
        <div class="file-input-wrapper">
            <input type="file" id="modelFile" accept=".onnx">
            <label for="modelFile" class="file-label">ðŸ“œ Choose Dragon Model (.onnx)</label>
        </div>
        <div class="model-status" id="modelStatus">No ancient tome selected...</div>
    </div>

    <div class="tab-nav">
        <button class="tab-button active" data-tab="hatchTab">
            <img src="assets/egg1.png"  style="width:25px; height:25px; vertical-align: middle;" alt="Reproduce Icon" class="button-icon">
            Hatch Egg
        </button>
        <button class="tab-button" data-tab="galleryTab">
            <img src="assets/black_dragon.png"  style="width:25px; height:25px; vertical-align: middle;" alt="Reproduce Icon" class="button-icon">
            Hatched Dragons
        </button>
        <button class="tab-button" data-tab="reproduceTab">
            <img src="assets/hearts.png"  style="width:25px; height:25px; vertical-align: middle;" alt="Reproduce Icon" class="button-icon">
            Reproduce
        </button>
    </div>
    
    
        

    
    <div id="hatchTab" class="tab-content active">
        <!-- Your egg hatching UI -->
        <div class="egg-container">
            <div class="dragon-egg" id="dragonEgg">
                <div class="egg-glow"></div>
                <div class="egg-patterns"></div>
                <div class="crack-line down"></div>
                <div class="crack-line up"></div>
                <div class="crack-line down"></div>
                <div class="crack-line up"></div>
            </div>
            <div class="loading-spinner" id="loadingSpinner"></div>
        </div>
        <div class="hatch-instruction" id="hatchInstruction">
            Click the dragon egg to hatch your unique creature
        </div>
        <div class="canvas-container" id="canvasContainer">
            <div class="canvas-title">Your Hatched Dragon</div>
            <canvas id="outputCanvas" class="dragon-canvas" width="256" height="256"></canvas>
        </div>
    </div>
    
    <div id="galleryTab" class="tab-content">
        <h2 style="text-align:center; color:white; margin-top:2rem;">All Hatched Dragons</h2>
        <div id="hatchedDragons" style="display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-top:1rem; margin-bottom: 1rem;"></div>
    </div>
    
    <div id="reproduceTab" class="tab-content">
        <h2 style="text-align:center; color:white; margin-top:2rem;">Reproduce Two Dragons</h2>
        <p style="text-align:center;">Select two dragons from the gallery below to combine them:</p>
        <div id="reproduceGallery" style="display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-top:1rem;"></div>
        <button id="reproduceButton">Reproduce them!</button>
        <div class="canvas-container" id="reproduceCanvasContainer">
            <div class="canvas-title">Your New Dragon</div>
            <canvas id="reproduceCanvas" class="dragon-canvas" width="256" height="256"></canvas>
        </div>
    </div>
    
    
    <div class="dragon-popup" id="dragonPopup">
        <div class="popup-content">
            <div class="close-popup" id="closePopup">Ã—</div>
            <div class="popup-title">Behold Your Unique Dragon! </div>
            <canvas id="popupCanvas" class="popup-canvas" width="512" height="512"></canvas>
            <div class="popup-instructions">Click outside or press Ã— to close</div>
        </div>
    </div>

    <script>
        
        let session;
        let modelLoaded = false;
        let isHatching = false; // Prevent multiple simultaneous hatching attempts

        // Popup functionality
        const dragonPopup = document.getElementById('dragonPopup');
        const closePopup = document.getElementById('closePopup');
        const mainCanvas = document.getElementById('outputCanvas');
        const popupCanvas = document.getElementById('popupCanvas');

        let dragonsData = [];


        

        function addDragonToGallery(originalCanvas, latentVector) {
            const gallery = document.getElementById('hatchedDragons');
            const copyCanvas = document.createElement('canvas');
            copyCanvas.width = originalCanvas.width;
            copyCanvas.height = originalCanvas.height;
            copyCanvas.getContext('2d').drawImage(originalCanvas, 0, 0);

            const img = new Image();
            img.src = copyCanvas.toDataURL();
            img.width = 100;
            img.height = 100;
            img.style.border = "2px solid white";
            img.style.borderRadius = "10px";
            img.style.boxShadow = "0 0 15px rgba(16, 185, 129, 0.5)";
            img.style.cursor = "pointer";

            // Click to show popup
            img.addEventListener('click', () => {
                const popupCtx = popupCanvas.getContext('2d');
                popupCtx.clearRect(0, 0, popupCanvas.width, popupCanvas.height);
                popupCtx.drawImage(copyCanvas, 0, 0, copyCanvas.width, copyCanvas.height, 0, 0, 512, 512);
                dragonPopup.classList.add('active');
            });

            gallery.appendChild(img);

            dragonsData.push({ latent: latentVector, image: img });
            refreshReproduceGallery();
        }


        let selectedForReproduction = [];

    function refreshReproduceGallery() {
        const reproduceGallery = document.getElementById('reproduceGallery');
        reproduceGallery.innerHTML = '';
        dragonsData.forEach((dragon, index) => {
            const clone = dragon.image.cloneNode(true);
            clone.addEventListener('click', () => {
                if (selectedForReproduction.includes(index)) {
                    selectedForReproduction = selectedForReproduction.filter(i => i !== index);
                    clone.style.border = "2px solid white";
                } else if (selectedForReproduction.length < 2) {
                    selectedForReproduction.push(index);
                    clone.style.border = "3px solid #e3390b";
                }
            });
            reproduceGallery.appendChild(clone);
        });
    }

        document.getElementById('reproduceButton').addEventListener('click', async () => {
            console.log("Selected for reproduction:", selectedForReproduction);
            console.log(dragonsData);
            if (selectedForReproduction.length !== 2 || !modelLoaded) return;
            const latent1 = dragonsData[selectedForReproduction[0]].latent;
            const latent2 = dragonsData[selectedForReproduction[1]].latent;
            const meanLatent = latent1.map((val, i) => (val + latent2[i]) / 2);
            const inputTensor = new ort.Tensor('float32', new Float32Array(meanLatent), [1, 1024]);
            const results = await session.run({ latent: inputTensor });
            const outputTensor = results.reconstructed;
            const [batch, channels, height, width] = outputTensor.dims;
            const data = outputTensor.data;
            const canvas = document.getElementById("reproduceCanvas");
            const ctx = canvas.getContext("2d");
            const imageData = ctx.createImageData(width, height);
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const i = y * width + x;
                    imageData.data[i * 4] = Math.min(Math.max(Math.floor(data[i] * 255), 0), 255);
                    imageData.data[i * 4 + 1] = Math.min(Math.max(Math.floor(data[i + width * height] * 255), 0), 255);
                    imageData.data[i * 4 + 2] = Math.min(Math.max(Math.floor(data[i + 2 * width * height] * 255), 0), 255);
                    imageData.data[i * 4 + 3] = 255;
                }
            }
            ctx.putImageData(imageData, 0, 0);
            document.getElementById('reproduceCanvasContainer').classList.add('revealed');
            addDragonToGallery(canvas, Array.from(meanLatent));
        });


        // Create mystical background particles
        function createMysticalParticles() {
            const container = document.getElementById('backgroundEffects');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'mystical-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (3 + Math.random() * 4) + 's';
                container.appendChild(particle);
            }
        }
        
        // Initialize mystical effects
        createMysticalParticles();
        
        // Load model from local file
        document.getElementById("modelFile").addEventListener("change", async (event) => {
            const file = event.target.files[0];
            const statusEl = document.getElementById("modelStatus");
            
            if (!file) {
                statusEl.textContent = "No ancient tome selected...";
                modelLoaded = false;
                return;
            }
            
            statusEl.textContent = "Deciphering ancient dragon magic...";
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                session = await ort.InferenceSession.create(arrayBuffer);
                modelLoaded = true;
                statusEl.innerHTML = "Dragon magic successfully learned! <br/>The egg is ready to hatch...";
            
                
                // Add magical glow to egg when model is loaded
                document.getElementById('dragonEgg').style.boxShadow = `
                    0 15px 40px rgba(16, 185, 129, 0.8),
                    inset -20px -20px 40px rgba(0, 0, 0, 0.3),
                    inset 20px 20px 40px rgba(255, 255, 255, 0.2)`;
                    
            } catch (error) {
                statusEl.textContent = "âŒ Failed to decipher the dragon magic. Please check your tome.";
                modelLoaded = false;
                console.error("Model loading error:", error);
            }
        });

        async function hatchDragon() {
            if (!modelLoaded) {
                
                return;
            }
            
            if (isHatching) {
                return; // Prevent multiple clicks during hatching
            }
            
            isHatching = true;
            
            const egg = document.getElementById('dragonEgg');
            const instruction = document.getElementById('hatchInstruction');
            const canvasContainer = document.getElementById('canvasContainer');
            const spinner = document.getElementById('loadingSpinner');
            
            // Disable egg interaction during hatching
            egg.classList.add('disabled');
            
            // Start hatching animation sequence
            egg.classList.add('hatching');
            instruction.classList.add('hidden');
            
            // After 2.5 seconds, stop shaking and start cracking
            setTimeout(() => {
                egg.classList.remove('hatching');
                egg.classList.add('cracked');
                spinner.classList.add('active');
            }, 2500);

            try {
                // Wait a bit for the visual crack effect, then start ML processing
                setTimeout(async () => {
                    
                    // Create a latent vector using Box-Muller transform for normal distribution
                    function randn_bm() {
                        let u = 0, v = 0;
                        while(u === 0) u = Math.random();
                        while(v === 0) v = Math.random();
                        return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
                    }

                    const latentVector = new Float32Array(1024).map(() => randn_bm());
                    const inputTensor = new ort.Tensor('float32', latentVector, [1, 1024]);
                    const feeds = { latent: inputTensor };

                    
                    const results = await session.run(feeds);
                    const outputTensor = results.reconstructed;

                    // Process the output tensor
                    const [batch, channels, height, width] = outputTensor.dims;
                    const data = outputTensor.data;
                    
                    const canvas = document.getElementById("outputCanvas");
                    const ctx = canvas.getContext("2d");
                    const imageData = ctx.createImageData(width, height);

                    for (let y = 0; y < height; y++) {
                        for (let x = 0; x < width; x++) {
                            const i = y * width + x;
                            const r = data[i];
                            const g = data[i + width * height];
                            const b = data[i + 2 * width * height];
                            const idx = i * 4;
                            
                            imageData.data[idx] = Math.min(Math.max(Math.floor(r * 255), 0), 255);
                            imageData.data[idx + 1] = Math.min(Math.max(Math.floor(g * 255), 0), 255);
                            imageData.data[idx + 2] = Math.min(Math.max(Math.floor(b * 255), 0), 255);
                            imageData.data[idx + 3] = 255;
                        }
                    }

                    // Reveal the dragon with a dramatic pause
                    setTimeout(() => {
                        ctx.putImageData(imageData, 0, 0);
                        addDragonToGallery(canvas, Array.from(latentVector));
                        
                        // Hide spinner and reveal the hatched dragon
                        spinner.classList.remove('active');
                        canvasContainer.classList.add('revealed');
                        
                        // Reset for next hatch after a longer delay
                        setTimeout(() => {
                            resetEggForNextHatch();
                        }, 1000);
                        
                    }, 1000);
                    
                }, 1500); // Wait 1.5 seconds after cracking starts
                
            } catch (err) {
                // Handle errors gracefully
                spinner.classList.remove('active');
                console.error("Inference error:", err);
                
                // Reset egg after error
                setTimeout(() => {
                    resetEggForNextHatch();
                }, 3000);
            }
        }
        
        function resetEggForNextHatch() {
            const egg = document.getElementById('dragonEgg');
            const instruction = document.getElementById('hatchInstruction');
            
            // Remove all animation classes
            egg.classList.remove('cracked', 'hatching', 'disabled');
            
            // Show instruction for next hatch
            instruction.classList.remove('hidden');
            instruction.textContent = "Click to hatch another dragon! ";
            
            // Reset hatching state
            isHatching = false;
        }

        // Add click event to dragon egg
        document.getElementById('dragonEgg').addEventListener('click', hatchDragon);
        

        
        function showDragonPopup() {
            if (document.getElementById('canvasContainer').classList.contains('revealed')) {
                const mainCtx = mainCanvas.getContext('2d');
                const popupCtx = popupCanvas.getContext('2d');
                
                popupCtx.imageSmoothingEnabled = false;
                popupCtx.drawImage(mainCanvas, 0, 0, 256, 256, 0, 0, 512, 512);
                
                dragonPopup.classList.add('active');
            }
        }
        
        function hideDragonPopup() {
            dragonPopup.classList.remove('active');
        }
        
        // Event listeners for popup
        mainCanvas.addEventListener('click', showDragonPopup);
        closePopup.addEventListener('click', hideDragonPopup);
        
        // Close popup when clicking outside the content
        dragonPopup.addEventListener('click', function(e) {
            if (e.target === dragonPopup) {
                hideDragonPopup();
            }
        });
        
        // Close popup with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && dragonPopup.classList.contains('active')) {
                hideDragonPopup();
            }
        });
        
        // Add interactive hover effects to the canvas
        mainCanvas.addEventListener('mouseenter', function() {
            if (document.getElementById('canvasContainer').classList.contains('revealed')) {
                this.style.transform = 'scale(1.05)';
                this.style.boxShadow = '0 0 40px rgba(16, 185, 129, 0.8), inset 0 0 30px rgba(16, 185, 129, 0.2)';
                this.style.cursor = 'pointer';
            }
        });
        
        mainCanvas.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = '0 0 30px rgba(16, 185, 129, 0.5), inset 0 0 20px rgba(16, 185, 129, 0.1)';
        });


        document.querySelectorAll('.tab-button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tabId = btn.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
    });
});

    </script>
</body>
</html>